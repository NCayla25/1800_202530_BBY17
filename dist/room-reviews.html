<!doctype html>
<html lang="en">
<head>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script>
    // Add your Firebase config here
    const firebaseConfig = {
      apiKey: "AIzaSyCKBAhVaZASZh8if6BV7m80rJHNsPkm1JE",
      authDomain: "reviewshandimap.firebaseapp.com",
      projectId: "reviewshandimap",
      storageBucket: "reviewshandimap.firebasestorage.app",
      messagingSenderId: "49195367914",
      appId: "1:49195367914:web:0fc045fc0a0dfd7bfa0693"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <meta charset="utf-8">
  <title>Room Reviews</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script type="module" crossorigin src="/assets/modulepreload-polyfill-B5Qt9EMX.js"></script>
  <script type="module" crossorigin src="/assets/fab-menu-Cwgyy1vS.js"></script>
  <link rel="stylesheet" crossorigin href="/assets/style-BBPP6_QE.css">
</head>
<body class="bg-light">
  <div class="container py-4">
    <!-- Header with room number -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 id="roomHeader" class="m-0 fw-bold"></h5>
      <div></div>
    </div>

    <!-- Average Rating Card -->
    <div class="card shadow-sm mb-4 p-3">
      <h6 class="fw-semibold mb-2">Overall Rating</h6>
      <div id="averageRating" class="fs-4 fw-bold"></div>
    </div>

    <!-- Add Review Form -->
    <div class="card shadow-sm mb-4 p-3">
      <h6 class="fw-semibold mb-3">Write a Review</h6>
      <form id="reviewForm">
        <div class="mb-3">
          <label class="form-label">Category</label>
          <select id="reviewCategory" class="form-select" required>
            <option value="">Select category</option>
            <option value="Elevator Access">Elevator Access</option>
            <option value="Wheelchair Friendliness">Wheelchair Friendliness</option>
            <option value="Shortest Path / Shortcuts">Shortest Path / Shortcuts</option>
            <option value="Door Accessibility">Door Accessibility</option>
            <option value="Seating Availability">Seating Availability</option>
            <option value="Washroom Accessibility">Washroom Accessibility</option>
            <option value="Noise Level">Noise Level</option>
            <option value="Lighting">Lighting</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Your Rating</label>
          <div class="d-flex gap-2">
            <button type="button" id="thumbUpBtn" class="btn btn-outline-success"><i class="bi bi-hand-thumbs-up"></i></button>
            <button type="button" id="thumbDownBtn" class="btn btn-outline-danger"><i class="bi bi-hand-thumbs-down"></i></button>
            <input type="hidden" id="reviewThumb" value="">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Your Name</label>
          <input type="text" id="reviewerName" class="form-control" placeholder="Enter your name" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Review</label>
          <textarea id="reviewText" class="form-control" rows="3" placeholder="Share your thoughts..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary w-100">Post Review</button>
      </form>
    </div>

    <!-- Reviews List -->
    <div id="reviewsList"></div>
  </div>
  <div id="fab-menu-root"></div>
  <script>
    // Get room from URL
    const room = localStorage.getItem("roomID");
    document.getElementById('roomHeader').textContent = room;

    // Thumbs up/down selection logic
    let selectedThumb = null;
    const thumbUpBtn = document.getElementById('thumbUpBtn');
    const thumbDownBtn = document.getElementById('thumbDownBtn');
    const reviewThumb = document.getElementById('reviewThumb');

    thumbUpBtn.addEventListener('click', () => {
      selectedThumb = 'up';
      reviewThumb.value = 'up';
      thumbUpBtn.classList.add('btn-success');
      thumbUpBtn.classList.remove('btn-outline-success');
      thumbDownBtn.classList.remove('btn-danger');
      thumbDownBtn.classList.add('btn-outline-danger');
    });
    thumbDownBtn.addEventListener('click', () => {
      selectedThumb = 'down';
      reviewThumb.value = 'down';
      thumbDownBtn.classList.add('btn-danger');
      thumbDownBtn.classList.remove('btn-outline-danger');
      thumbUpBtn.classList.remove('btn-success');
      thumbUpBtn.classList.add('btn-outline-success');
    });

    // Get current user ID (create one if doesn't exist)
    function getUserId() {
      let userId = localStorage.getItem('userId');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
      }
      return userId;
    }
    const currentUserId = getUserId();

    // Firestore CRUD for reviews
    async function getRoomReviews() {
      try {
        const snapshot = await db.collection('roomReviews').where('room', '==', room).get();
        console.log('Loaded reviews:', snapshot.docs.length);
        return snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
      } catch (error) {
        console.error('Error loading reviews:', error);
        return [];
      }
    }

    async function saveRoomReview(review) {
      try {
        review.room = room;
        review.timestamp = Date.now();
        console.log('Saving review:', review);
        const docRef = await db.collection('roomReviews').add(review);
        console.log('Review saved with ID:', docRef.id);
        return { success: true, id: docRef.id };
      } catch (error) {
        console.error('Error saving review:', error);
        alert('Error saving review: ' + error.message);
        return { success: false, error };
      }
    }

    async function editRoomReview(id, review) {
      try {
        await db.collection('roomReviews').doc(id).set(review);
        console.log('Review updated:', id);
        return { success: true };
      } catch (error) {
        console.error('Error updating review:', error);
        return { success: false, error };
      }
    }

    async function deleteRoomReview(id) {
      try {
        await db.collection('roomReviews').doc(id).delete();
        console.log('Review deleted:', id);
        return { success: true };
      } catch (error) {
        console.error('Error deleting review:', error);
        return { success: false, error };
      }
    }

    // Calculate average rating
    function calculateAverageRating(reviews) {
      if (reviews.length === 0) {
        return { percentage: 0, sentiment: 'No reviews yet', total: 0 };
      }
      let totalVotes = 0;
      let positiveVotes = 0;
      reviews.forEach(review => {
        totalVotes += review.thumbsUp + review.thumbsDown;
        positiveVotes += review.thumbsUp;
      });
      if (totalVotes === 0) {
        return { percentage: 0, sentiment: 'No votes yet', total: reviews.length };
      }
      const percentage = Math.round((positiveVotes / totalVotes) * 100);
      const sentiment = percentage >= 50 ? 'Positive' : 'Negative';
      return { percentage, sentiment, total: reviews.length };
    }

    // Update average rating display
    async function updateAverageRating() {
      const reviews = await getRoomReviews();
      const rating = calculateAverageRating(reviews);
      const ratingEl = document.getElementById('averageRating');
      if (rating.total === 0) {
        ratingEl.innerHTML = '<span class="text-muted">No reviews yet</span>';
      } else if (rating.percentage === 0) {
        ratingEl.innerHTML = `<span class="text-muted">${rating.sentiment} (${rating.total} review${rating.total !== 1 ? 's' : ''})</span>`;
      } else {
        const colorClass = rating.percentage >= 50 ? 'text-success' : 'text-danger';
        ratingEl.innerHTML = `<span class="${colorClass}">${rating.percentage}% ${rating.sentiment}</span> <span class="text-muted fs-6">(${rating.total} review${rating.total !== 1 ? 's' : ''})</span>`;
      }
    }

    // Render reviews
    function renderReviews() {
      getRoomReviews().then(reviews => {
        const reviewsList = document.getElementById('reviewsList');
        reviewsList.innerHTML = '';
        if (reviews.length === 0) {
          reviewsList.innerHTML = '<div class="text-muted text-center p-4">No reviews yet for this room.</div>';
          return;
        }
        reviews.forEach((review, index) => {
          const reviewCard = document.createElement('div');
          reviewCard.className = 'card shadow-sm mb-3';
          if (review.userId === currentUserId && review._editing) {
            // Edit form for own review
            reviewCard.innerHTML = `
              <div class="card-body">
                <form class="edit-review-form" data-index="${index}">
                  <div class="mb-2">
                    <label class="form-label">Category</label>
                    <select class="form-select edit-category">
                      <option value="Elevator Access">Elevator Access</option>
                      <option value="Wheelchair Friendliness">Wheelchair Friendliness</option>
                      <option value="Shortest Path / Shortcuts">Shortest Path / Shortcuts</option>
                      <option value="Door Accessibility">Door Accessibility</option>
                      <option value="Seating Availability">Seating Availability</option>
                      <option value="Washroom Accessibility">Washroom Accessibility</option>
                      <option value="Noise Level">Noise Level</option>
                      <option value="Lighting">Lighting</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Your Rating</label>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-outline-success edit-thumb-up"><i class="bi bi-hand-thumbs-up"></i></button>
                      <button type="button" class="btn btn-outline-danger edit-thumb-down"><i class="bi bi-hand-thumbs-down"></i></button>
                    </div>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Review</label>
                    <textarea class="form-control edit-text" rows="2"></textarea>
                  </div>
                  <button type="submit" class="btn btn-primary btn-sm">Save</button>
                  <button type="button" class="btn btn-secondary btn-sm cancel-edit">Cancel</button>
                </form>
              </div>
            `;
          } else {
            reviewCard.innerHTML = `
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <div>
                    <h6 class="fw-semibold mb-1">${escapeHtml(review.name)}</h6>
                    <span class="badge bg-secondary me-2">${escapeHtml(review.category)}</span>
                    <small class="text-muted">${new Date(review.timestamp).toLocaleDateString()}</small>
                    <span class="ms-2">${review.userVote === 'up' ? '<i class=\'bi bi-hand-thumbs-up text-success\'></i>' : '<i class=\'bi bi-hand-thumbs-down text-danger\'></i>'}</span>
                  </div>
                  ${review.userId === currentUserId ? `<button class=\"btn btn-sm btn-outline-warning edit-btn\" data-index=\"${index}\"><i class=\"bi bi-pencil\"></i> Edit Review</button> <button class=\"btn btn-sm btn-outline-danger delete-btn\" data-index=\"${index}\"><i class=\"bi bi-trash\"></i> Delete</button>` : ''}
                </div>
                <p class="mb-3">${escapeHtml(review.text)}</p>
                <!-- Thumbs up/down voting for non-authors only -->
                <div class="d-flex align-items-center gap-3 mb-3">
                  <button class="btn btn-sm ${review.userVote === 'up' ? 'btn-success' : 'btn-outline-success'} thumb-btn" data-index="${index}" data-type="up" ${review.userId === currentUserId ? 'disabled' : ''}>
                    <i class="bi bi-hand-thumbs-up"></i> ${review.thumbsUp}
                  </button>
                  <button class="btn btn-sm ${review.userVote === 'down' ? 'btn-danger' : 'btn-outline-danger'} thumb-btn" data-index="${index}" data-type="down" ${review.userId === currentUserId ? 'disabled' : ''}>
                    <i class="bi bi-hand-thumbs-down"></i> ${review.thumbsDown}
                  </button>
                </div>
                <!-- Replies -->
                <div class="replies-section">
                  ${review.replies && review.replies.length > 0 ? `
                    <div class="ms-4 border-start ps-3">
                      ${review.replies.map((reply, replyIndex) => `
                        <div class="mb-2 p-2 bg-light rounded">
                          <div class="d-flex justify-content-between align-items-start">
                            <div>
                              <strong class="small">${escapeHtml(reply.name)}</strong>
                              <small class="text-muted ms-2">${new Date(reply.timestamp).toLocaleDateString()}</small>
                            </div>
                            ${reply.userId === currentUserId ? `<button class=\"btn btn-sm btn-link text-danger p-0 delete-reply-btn\" data-index=\"${index}\" data-reply-index=\"${replyIndex}\"><i class=\"bi bi-trash\"></i></button>` : ''}
                          </div>
                          <p class="mb-0 small mt-1">${escapeHtml(reply.text)}</p>
                        </div>
                      `).join('')}
                    </div>
                  ` : ''}
                  <!-- Reply Form -->
                  <form class="reply-form mt-2" data-index="${index}">
                    <div class="input-group input-group-sm">
                      <input type="text" class="form-control reply-name" placeholder="Your name" required>
                      <input type="text" class="form-control reply-text" placeholder="Write a reply..." required>
                      <button type="submit" class="btn btn-outline-primary">Reply</button>
                    </div>
                  </form>
                </div>
              </div>
            `;
          }
          reviewsList.appendChild(reviewCard);
        });
        // Edit button logic
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.currentTarget.dataset.index);
            getRoomReviews().then(reviews => {
              reviews[index]._editing = true;
              editRoomReview(index, reviews[index]).then(() => renderReviews());
            });
          });
        });
        // Cancel edit logic
        document.querySelectorAll('.cancel-edit').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.currentTarget.closest('.edit-review-form').dataset.index);
            getRoomReviews().then(reviews => {
              delete reviews[index]._editing;
              editRoomReview(index, reviews[index]).then(() => renderReviews());
            });
          });
        });
        // Edit form logic
        document.querySelectorAll('.edit-review-form').forEach(form => {
          const index = parseInt(form.dataset.index);
          getRoomReviews().then(reviews => {
            // Pre-fill fields
            form.querySelector('.edit-category').value = reviews[index].category;
            form.querySelector('.edit-text').value = reviews[index].text;
            // Thumb selection
            const thumbUpBtn = form.querySelector('.edit-thumb-up');
            const thumbDownBtn = form.querySelector('.edit-thumb-down');
            let selectedThumb = reviews[index].userVote;
            if (selectedThumb === 'up') {
              thumbUpBtn.classList.add('btn-success');
              thumbUpBtn.classList.remove('btn-outline-success');
              thumbDownBtn.classList.remove('btn-danger');
              thumbDownBtn.classList.add('btn-outline-danger');
            } else if (selectedThumb === 'down') {
              thumbDownBtn.classList.add('btn-danger');
              thumbDownBtn.classList.remove('btn-outline-danger');
              thumbUpBtn.classList.remove('btn-success');
              thumbUpBtn.classList.add('btn-outline-success');
            }
            thumbUpBtn.addEventListener('click', () => {
              selectedThumb = 'up';
              thumbUpBtn.classList.add('btn-success');
              thumbUpBtn.classList.remove('btn-outline-success');
              thumbDownBtn.classList.remove('btn-danger');
              thumbDownBtn.classList.add('btn-outline-danger');
            });
            thumbDownBtn.addEventListener('click', () => {
              selectedThumb = 'down';
              thumbDownBtn.classList.add('btn-danger');
              thumbDownBtn.classList.remove('btn-outline-danger');
              thumbUpBtn.classList.remove('btn-success');
              thumbUpBtn.classList.add('btn-outline-success');
            });
            form.addEventListener('submit', (e) => {
              e.preventDefault();
              const category = form.querySelector('.edit-category').value;
              const text = form.querySelector('.edit-text').value.trim();
              if (!category || !text || !selectedThumb) return;
              reviews[index].category = category;
              reviews[index].text = text;
              reviews[index].userVote = selectedThumb;
              reviews[index].thumbsUp = selectedThumb === 'up' ? 1 : 0;
              reviews[index].thumbsDown = selectedThumb === 'down' ? 1 : 0;
              reviews[index].votes = { [currentUserId]: selectedThumb };
              delete reviews[index]._editing;
              editRoomReview(index, reviews[index]).then(() => {
                updateAverageRating();
                renderReviews();
              });
            });
          });
        });
        attachEventListeners();
      });
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Attach event listeners to dynamic elements
    function attachEventListeners() {
      // Delete review buttons
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.dataset.index);
          if (confirm('Are you sure you want to delete this review?')) {
            deleteReview(index);
          }
        });
      });
      // Delete reply buttons
      document.querySelectorAll('.delete-reply-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.dataset.index);
          const replyIndex = parseInt(e.currentTarget.dataset.replyIndex);
          if (confirm('Are you sure you want to delete this reply?')) {
            deleteReply(index, replyIndex);
          }
        });
      });
      // Reply forms
      document.querySelectorAll('.reply-form').forEach(form => {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const index = parseInt(e.currentTarget.dataset.index);
          const nameInput = form.querySelector('.reply-name');
          const textInput = form.querySelector('.reply-text');
          if (nameInput.value.trim() && textInput.value.trim()) {
            addReply(index, nameInput.value.trim(), textInput.value.trim());
            nameInput.value = '';
            textInput.value = '';
          }
        });
      });
    }

    // Add new review
    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const category = document.getElementById('reviewCategory').value;
      const name = document.getElementById('reviewerName').value.trim();
      const text = document.getElementById('reviewText').value.trim();
      const thumb = reviewThumb.value;
      if (!category || !name || !text || !thumb) return;
      
      const newReview = {
        userId: currentUserId,
        category,
        name,
        text,
        thumbsUp: thumb === 'up' ? 1 : 0,
        thumbsDown: thumb === 'down' ? 1 : 0,
        userVote: thumb,
        votes: { [currentUserId]: thumb },
        replies: []
      };
      
      await saveRoomReview(newReview);
      
      // Clear form
      document.getElementById('reviewCategory').value = '';
      document.getElementById('reviewerName').value = '';
      document.getElementById('reviewText').value = '';
      reviewThumb.value = '';
      thumbUpBtn.classList.remove('btn-success');
      thumbUpBtn.classList.add('btn-outline-success');
      thumbDownBtn.classList.remove('btn-danger');
      thumbDownBtn.classList.add('btn-outline-danger');
      
      renderReviews();
    });

    // Delete review
    async function deleteReview(index) {
      const reviews = await getRoomReviews();
      const reviewId = reviews[index].id;
      await deleteRoomReview(reviewId);
      renderReviews();
    }

    // Delete reply
    async function deleteReply(reviewIndex, replyIndex) {
      const reviews = await getRoomReviews();
      const review = reviews[reviewIndex];
      review.replies.splice(replyIndex, 1);
      await editRoomReview(review.id, review);
      renderReviews();
    }

    // Add reply to review
    async function addReply(index, name, text) {
      const reviews = await getRoomReviews();
      const review = reviews[index];
      const reply = {
        userId: currentUserId,
        name,
        text,
        timestamp: Date.now()
      };
      if (!review.replies) {
        review.replies = [];
      }
      review.replies.push(reply);
      await editRoomReview(review.id, review);
      renderReviews();
    }

    // Initial render
    updateAverageRating();
    renderReviews();
  </script>
</body>
</html>
