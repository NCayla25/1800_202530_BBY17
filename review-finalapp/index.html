<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Reviews</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">

    <!-- Header and Filter -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 id="resultsHeader" class="m-0 fw-bold">Accessibility Reviews</h5>
      <div class="ms-3">
        <select id="categoryFilter" class="form-select">
          <option value="all">All Categories</option>
          <option value="Elevator Access">Elevator Access</option>
          <option value="Wheelchair Friendliness">Wheelchair Friendliness</option>
          <option value="Shortest Path / Shortcuts">Shortest Path / Shortcuts</option>
          <option value="Door Accessibility">Door Accessibility</option>
          <option value="Seating Availability">Seating Availability</option>
          <option value="Washroom Accessibility">Washroom Accessibility</option>
          <option value="Noise Level">Noise Level</option>
          <option value="Lighting">Lighting</option>
        </select>
      </div>
    </div>

    <!-- Average Rating Card -->
    <div class="card shadow-sm mb-4 p-3">
      <h6 class="fw-semibold mb-2">Overall Rating</h6>
      <div id="averageRating" class="fs-4 fw-bold"></div>
    </div>

    <!-- Add Review Form -->
    <div class="card shadow-sm mb-4 p-3">
      <h6 class="fw-semibold mb-3">Write a Review</h6>
      <form id="reviewForm">
        <div class="mb-3">
          <label class="form-label">Category</label>
          <select id="reviewCategory" class="form-select" required>
            <option value="">Select category</option>
            <option value="Elevator Access">Elevator Access</option>
            <option value="Wheelchair Friendliness">Wheelchair Friendliness</option>
            <option value="Shortest Path / Shortcuts">Shortest Path / Shortcuts</option>
            <option value="Door Accessibility">Door Accessibility</option>
            <option value="Seating Availability">Seating Availability</option>
            <option value="Washroom Accessibility">Washroom Accessibility</option>
            <option value="Noise Level">Noise Level</option>
            <option value="Lighting">Lighting</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Your Rating</label>
          <div class="d-flex gap-2">
            <button type="button" id="thumbUpBtn" class="btn btn-outline-success"><i class="bi bi-hand-thumbs-up"></i></button>
            <button type="button" id="thumbDownBtn" class="btn btn-outline-danger"><i class="bi bi-hand-thumbs-down"></i></button>
            <input type="hidden" id="reviewThumb" value="">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Your Name</label>
          <input type="text" id="reviewerName" class="form-control" placeholder="Enter your name" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Review</label>
          <textarea id="reviewText" class="form-control" rows="3" placeholder="Share your thoughts..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary w-100">Post Review</button>
      </form>
    </div>

    <!-- Reviews List -->
    <div id="reviewsList"></div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
     const building = params.get('building') || null;
     const room = params.get('room') || null;
     const roomKey = (building && room) ? `${building}-${room}` : 'general';

    // Set header
     document.getElementById('resultsHeader').textContent = room || 'Accessibility Reviews';

    // LocalStorage key for reviews
    const STORAGE_KEY = 'accessibilityReviews';
    // Thumbs up/down selection logic
    let selectedThumb = null;
    const thumbUpBtn = document.getElementById('thumbUpBtn');
    const thumbDownBtn = document.getElementById('thumbDownBtn');
    const reviewThumb = document.getElementById('reviewThumb');

    thumbUpBtn.addEventListener('click', () => {
      selectedThumb = 'up';
      reviewThumb.value = 'up';
      thumbUpBtn.classList.add('btn-success');
      thumbUpBtn.classList.remove('btn-outline-success');
      thumbDownBtn.classList.remove('btn-danger');
      thumbDownBtn.classList.add('btn-outline-danger');
    });
    thumbDownBtn.addEventListener('click', () => {
      selectedThumb = 'down';
      reviewThumb.value = 'down';
      thumbDownBtn.classList.add('btn-danger');
      thumbDownBtn.classList.remove('btn-outline-danger');
      thumbUpBtn.classList.remove('btn-success');
      thumbUpBtn.classList.add('btn-outline-success');
    });

    // Get current user ID (create one if doesn't exist)
    function getUserId() {
      let userId = localStorage.getItem('userId');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
      }
      return userId;
    }

    const currentUserId = getUserId();

    // Load all reviews from localStorage
    function loadReviews() {
      const data = localStorage.getItem(STORAGE_KEY);
      return data ? JSON.parse(data) : {};
    }

    // Save reviews to localStorage
    function saveReviews(reviews) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(reviews));
    }

    // Get reviews for current room
    function getRoomReviews() {
      const allReviews = loadReviews();
      return allReviews[roomKey] || [];
    }

    // Save reviews for current room
    function saveRoomReviews(reviews) {
      const allReviews = loadReviews();
      allReviews[roomKey] = reviews;
      saveReviews(allReviews);
    }

    // Calculate average rating
    function calculateAverageRating(reviews) {
      if (reviews.length === 0) {
        return { percentage: 0, sentiment: 'No reviews yet', total: 0 };
      }

      let totalVotes = 0;
      let positiveVotes = 0;

      reviews.forEach(review => {
        totalVotes += review.thumbsUp + review.thumbsDown;
        positiveVotes += review.thumbsUp;
      });

      if (totalVotes === 0) {
        return { percentage: 0, sentiment: 'No votes yet', total: reviews.length };
      }

      const percentage = Math.round((positiveVotes / totalVotes) * 100);
      const sentiment = percentage >= 50 ? 'Positive' : 'Negative';
      
      return { percentage, sentiment, total: reviews.length };
    }

    // Update average rating display
    function updateAverageRating() {
      const reviews = getRoomReviews();
      const rating = calculateAverageRating(reviews);
      const ratingEl = document.getElementById('averageRating');
      
      if (rating.total === 0) {
        ratingEl.innerHTML = '<span class="text-muted">No reviews yet</span>';
      } else if (rating.percentage === 0) {
        ratingEl.innerHTML = `<span class="text-muted">${rating.sentiment} (${rating.total} review${rating.total !== 1 ? 's' : ''})</span>`;
      } else {
        const colorClass = rating.percentage >= 50 ? 'text-success' : 'text-danger';
        ratingEl.innerHTML = `<span class="${colorClass}">${rating.percentage}% ${rating.sentiment}</span> <span class="text-muted fs-6">(${rating.total} review${rating.total !== 1 ? 's' : ''})</span>`;
      }
    }

    // Render reviews with filter
    function renderReviews() {
      const reviews = getRoomReviews();
      const filter = document.getElementById('categoryFilter').value;
      const reviewsList = document.getElementById('reviewsList');
      reviewsList.innerHTML = '';

      const filteredReviews = filter === 'all' ? reviews : reviews.filter(r => r.category === filter);

      if (filteredReviews.length === 0) {
        reviewsList.innerHTML = '<div class="text-muted text-center p-4">No reviews yet for this category.</div>';
        return;
      }

      filteredReviews.forEach((review, index) => {
        const reviewCard = document.createElement('div');
        reviewCard.className = 'card shadow-sm mb-3';
        reviewCard.innerHTML = `
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="fw-semibold mb-1">${escapeHtml(review.name)}</h6>
                <span class="badge bg-secondary me-2">${escapeHtml(review.category)}</span>
                <small class="text-muted">${new Date(review.timestamp).toLocaleDateString()}</small>
              </div>
              ${review.userId === currentUserId ? `<button class="btn btn-sm btn-outline-danger delete-btn" data-index="${index}"><i class="bi bi-trash"></i> Delete</button>` : ''}
            </div>
            <p class="mb-3">${escapeHtml(review.text)}</p>
            <!-- Thumbs up/down -->
            <div class="d-flex align-items-center gap-3 mb-3">
              <button class="btn btn-sm ${review.userVote === 'up' ? 'btn-success' : 'btn-outline-success'} thumb-btn" data-index="${index}" data-type="up">
                <i class="bi bi-hand-thumbs-up"></i> ${review.thumbsUp}
              </button>
              <button class="btn btn-sm ${review.userVote === 'down' ? 'btn-danger' : 'btn-outline-danger'} thumb-btn" data-index="${index}" data-type="down">
                <i class="bi bi-hand-thumbs-down"></i> ${review.thumbsDown}
              </button>
            </div>
            <!-- Replies -->
            <div class="replies-section">
              ${review.replies && review.replies.length > 0 ? `
                <div class="ms-4 border-start ps-3">
                  ${review.replies.map((reply, replyIndex) => `
                    <div class="mb-2 p-2 bg-light rounded">
                      <div class="d-flex justify-content-between align-items-start">
                        <div>
                          <strong class="small">${escapeHtml(reply.name)}</strong>
                          <small class="text-muted ms-2">${new Date(reply.timestamp).toLocaleDateString()}</small>
                        </div>
                        ${reply.userId === currentUserId ? `<button class="btn btn-sm btn-link text-danger p-0 delete-reply-btn" data-index="${index}" data-reply-index="${replyIndex}"><i class="bi bi-trash"></i></button>` : ''}
                      </div>
                      <p class="mb-0 small mt-1">${escapeHtml(reply.text)}</p>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              <!-- Reply Form -->
              <form class="reply-form mt-2" data-index="${index}">
                <div class="input-group input-group-sm">
                  <input type="text" class="form-control reply-name" placeholder="Your name" required>
                  <input type="text" class="form-control reply-text" placeholder="Write a reply..." required>
                  <button type="submit" class="btn btn-outline-primary">Reply</button>
                </div>
              </form>
            </div>
          </div>
        `;
        reviewsList.appendChild(reviewCard);
      });
      attachEventListeners();
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Attach event listeners to dynamic elements
    function attachEventListeners() {
      // Delete review buttons
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.dataset.index);
          if (confirm('Are you sure you want to delete this review?')) {
            deleteReview(index);
          }
        });
      });

      // Delete reply buttons
      document.querySelectorAll('.delete-reply-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.dataset.index);
          const replyIndex = parseInt(e.currentTarget.dataset.replyIndex);
          if (confirm('Are you sure you want to delete this reply?')) {
            deleteReply(index, replyIndex);
          }
        });
      });

      // Thumbs up/down buttons
      document.querySelectorAll('.thumb-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.dataset.index);
          const type = e.currentTarget.dataset.type;
          voteOnReview(index, type);
        });
      });

      // Reply forms
      document.querySelectorAll('.reply-form').forEach(form => {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const index = parseInt(e.currentTarget.dataset.index);
          const nameInput = form.querySelector('.reply-name');
          const textInput = form.querySelector('.reply-text');
          
          if (nameInput.value.trim() && textInput.value.trim()) {
            addReply(index, nameInput.value.trim(), textInput.value.trim());
            nameInput.value = '';
            textInput.value = '';
          }
        });
      });
    }

    // Add new review
    document.getElementById('reviewForm').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const category = document.getElementById('reviewCategory').value;
      const name = document.getElementById('reviewerName').value.trim();
      const text = document.getElementById('reviewText').value.trim();
      const thumb = reviewThumb.value;
      if (!category || !name || !text || !thumb) return;

      const reviews = getRoomReviews();
      const newReview = {
        id: Date.now(),
        userId: currentUserId,
        category,
        name,
        text,
        timestamp: Date.now(),
        thumbsUp: thumb === 'up' ? 1 : 0,
        thumbsDown: thumb === 'down' ? 1 : 0,
        userVote: thumb,
        votes: { [currentUserId]: thumb },
        replies: []
      };

      reviews.unshift(newReview); // Add to beginning
      saveRoomReviews(reviews);
      // Clear form
      document.getElementById('reviewCategory').value = '';
      document.getElementById('reviewerName').value = '';
      document.getElementById('reviewText').value = '';
      reviewThumb.value = '';
      thumbUpBtn.classList.remove('btn-success');
      thumbUpBtn.classList.add('btn-outline-success');
      thumbDownBtn.classList.remove('btn-danger');
      thumbDownBtn.classList.add('btn-outline-danger');
      updateAverageRating();
      renderReviews();
    });

    // Delete review
    function deleteReview(index) {
      const reviews = getRoomReviews();
      reviews.splice(index, 1);
      saveRoomReviews(reviews);
      updateAverageRating();
      renderReviews();
    }

    // Delete reply
    function deleteReply(reviewIndex, replyIndex) {
      const reviews = getRoomReviews();
      reviews[reviewIndex].replies.splice(replyIndex, 1);
      saveRoomReviews(reviews);
      renderReviews();
    }

    // Vote on review
    function voteOnReview(index, type) {
      const reviews = getRoomReviews();
      const review = reviews[index];
      
      // Check if user already voted
      const previousVote = review.votes[currentUserId];
      
      if (previousVote === type) {
        // Remove vote if clicking same button
        delete review.votes[currentUserId];
        if (type === 'up') review.thumbsUp--;
        else review.thumbsDown--;
        review.userVote = null;
      } else {
        // Remove previous vote if exists
        if (previousVote) {
          if (previousVote === 'up') review.thumbsUp--;
          else review.thumbsDown--;
        }
        
        // Add new vote
        review.votes[currentUserId] = type;
        if (type === 'up') review.thumbsUp++;
        else review.thumbsDown++;
        review.userVote = type;
      }

      saveRoomReviews(reviews);
      updateAverageRating();
      renderReviews();
    }

    // Add reply to review
    function addReply(index, name, text) {
      const reviews = getRoomReviews();
      const reply = {
        id: Date.now(),
        userId: currentUserId,
        name,
        text,
        timestamp: Date.now()
      };
      
      if (!reviews[index].replies) {
        reviews[index].replies = [];
      }
      
      reviews[index].replies.push(reply);
      saveRoomReviews(reviews);
      renderReviews();
    }

    // Initial render
    document.getElementById('categoryFilter').addEventListener('change', () => {
      renderReviews();
    });
    updateAverageRating();
    renderReviews();
  </script>
</body>
</html>
