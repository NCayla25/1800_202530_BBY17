<!doctype html>
<html lang="en">
<head>
  <!-- Load Firebase SDKs so this page can connect to Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    /* Initialize Firebase and Firestore.
       This configuration connects the page to my Firestore project so all reviews,
       replies, and rating data can be stored and retrieved in real time. */
    const firebaseConfig = {
      apiKey: "AIzaSyCKBAhVaZASZh8if6BV7m80rJHNsPkm1JE",
      authDomain: "reviewshandimap.firebaseapp.com",
      projectId: "reviewshandimap",
      storageBucket: "reviewshandimap.firebasestorage.app",
      messagingSenderId: "49195367914",
      appId: "1:49195367914:web:0fc045fc0a0dfd7bfa0693"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <meta charset="utf-8">
  <title>Room Reviews</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- UI frameworks + icons + local stylesheet -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="./styles/style.css">
</head>

<body class="bg-light">
  <div class="container py-4">

    <!-- Display the room number the user selected. Stored earlier in localStorage. -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 id="roomHeader" class="m-0 fw-bold"></h5>
      <div></div>
    </div>

    <!-- Average rating section. Shows computed positivity/negativity % based on all reviews. -->
    <div class="card shadow-sm mb-4 p-3">
      <h6 class="fw-semibold mb-2">Overall Rating</h6>
      <div id="averageRating" class="fs-4 fw-bold"></div>
    </div>

    <!-- Review form: users select a category, pick thumbs up/down, enter name + text,
         and submit a structured review. Form data will be validated and saved to Firestore. -->
    <div class="card shadow-sm mb-4 p-3">
      <h6 class="fw-semibold mb-3">Write a Review</h6>

      <form id="reviewForm">

        <!-- Category dropdown helps group reviews into accessibility-related topic areas -->
        <div class="mb-3">
          <label class="form-label">Category</label>
          <select id="reviewCategory" class="form-select" required>
            <option value="">Select category</option>
            <option value="Elevator Access">Elevator Access</option>
            <option value="Wheelchair Friendliness">Wheelchair Friendliness</option>
            <option value="Shortest Path / Shortcuts">Shortest Path / Shortcuts</option>
            <option value="Door Accessibility">Door Accessibility</option>
            <option value="Seating Availability">Seating Availability</option>
            <option value="Washroom Accessibility">Washroom Accessibility</option>
            <option value="Noise Level">Noise Level</option>
            <option value="Lighting">Lighting</option>
          </select>
        </div>

        <!-- It uses a simple thumbs-based rating system instead of star ratings
             to make reviews faster and more approachable for users. -->
        <div class="mb-3">
          <label class="form-label">Your Rating</label>
          <div class="d-flex gap-2">
            <button type="button" id="thumbUpBtn" class="btn btn-outline-success">
              <i class="bi bi-hand-thumbs-up"></i>
            </button>
            <button type="button" id="thumbDownBtn" class="btn btn-outline-danger">
              <i class="bi bi-hand-thumbs-down"></i>
            </button>
            <!-- Stored value for the rating (up/down) used when saving to Firestore -->
            <input type="hidden" id="reviewThumb" value="">
          </div>
        </div>

        <!-- Name field so reviews feel personal and identifiable -->
        <div class="mb-3">
          <label class="form-label">Your Name</label>
          <input type="text" id="reviewerName" class="form-control" placeholder="Enter your name" required>
        </div>

        <!-- Main review text field for user comments -->
        <div class="mb-3">
          <label class="form-label">Review</label>
          <textarea id="reviewText" class="form-control" rows="3" placeholder="Share your thoughts..." required></textarea>
        </div>

        <button type="submit" class="btn btn-primary w-100">Post Review</button>
      </form>
    </div>

    <!-- All rendered reviews (cards) will be added here dynamically -->
    <div id="reviewsList"></div>
  </div>

  <!-- Floating action button menu (separate component) -->
  <div id="fab-menu-root"></div>
  <script type="module" src="/src/fab-menu.js"></script>

  <script>
    /* Retrieve and display the chosen room ID so users know which room theyâ€™re reviewing. */
    const room = localStorage.getItem("roomID");
    document.getElementById('roomHeader').textContent = room;

    /* UI logic for thumbs up/down buttons.
       Ensures only one rating can be selected and updates the hidden input
       used when saving the review. */
    let selectedThumb = null;
    const thumbUpBtn = document.getElementById('thumbUpBtn');
    const thumbDownBtn = document.getElementById('thumbDownBtn');
    const reviewThumb = document.getElementById('reviewThumb');

    thumbUpBtn.addEventListener('click', () => {
      selectedThumb = 'up';
      reviewThumb.value = 'up';
      thumbUpBtn.classList.add('btn-success');
      thumbUpBtn.classList.remove('btn-outline-success');
      thumbDownBtn.classList.remove('btn-danger');
      thumbDownBtn.classList.add('btn-outline-danger');
    });

    thumbDownBtn.addEventListener('click', () => {
      selectedThumb = 'down';
      reviewThumb.value = 'down';
      thumbDownBtn.classList.add('btn-danger');
      thumbDownBtn.classList.remove('btn-outline-danger');
      thumbUpBtn.classList.remove('btn-success');
      thumbUpBtn.classList.add('btn-outline-success');
    });

    /* Generates or retrieves a persistent user ID stored in localStorage.
       This ID is used to determine which reviews belong to the current user
       so they can edit or delete only their own posts. */
    function getUserId() {
      let userId = localStorage.getItem('userId');
      if (!userId) {
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', userId);
      }
      return userId;
    }
    const currentUserId = getUserId();

    /* Retrieves all reviews for the selected room from Firestore.
       Each review document is returned along with its Firestore ID so it can
       be edited or deleted later. */
    async function getRoomReviews() {
      try {
        const snapshot = await db.collection('roomReviews').where('room', '==', room).get();
        return snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
      } catch (error) {
        console.error('Error loading reviews:', error);
        return [];
      }
    }

    /* Saves a new review to Firestore.
       Attaches metadata including timestamp, userId, and initial vote state
       so the review can be displayed accurately and included in rating calculations. */
    async function saveRoomReview(review) {
      try {
        review.room = room;
        review.timestamp = Date.now();
        const docRef = await db.collection('roomReviews').add(review);
        return { success: true, id: docRef.id };
      } catch (error) {
        alert('Error saving review: ' + error.message);
        return { success: false };
      }
    }

    /* Updates an existing review document in Firestore.
       Overwrites the old values with the updated ones while keeping the same ID. */
    async function editRoomReview(id, review) {
      try {
        await db.collection('roomReviews').doc(id).set(review);
        return { success: true };
      } catch (error) {
        return { success: false };
      }
    }

    /* Deletes a review from Firestore.
       Only available to the author of the review through UI restrictions. */
    async function deleteRoomReview(id) {
      try {
        await db.collection('roomReviews').doc(id).delete();
        return { success: true };
      } catch (error) {
        return { success: false };
      }
    }

    /* Calculates the overall thumbs-up percentage across all reviews.
       Used to show the room's general accessibility sentiment. */
    function calculateAverageRating(reviews) {
      if (reviews.length === 0) return { percentage: 0, sentiment: 'No reviews', total: 0 };

      let totalVotes = 0, positiveVotes = 0;
      reviews.forEach(review => {
        totalVotes += review.thumbsUp + review.thumbsDown;
        positiveVotes += review.thumbsUp;
      });

      if (totalVotes === 0) return { percentage: 0, sentiment: 'No votes', total: reviews.length };

      const percentage = Math.round((positiveVotes / totalVotes) * 100);
      const sentiment = percentage >= 50 ? 'Positive' : 'Negative';

      return { percentage, sentiment, total: reviews.length };
    }

    /* Updates the average rating UI whenever reviews change.
       Reflects the overall accessibility experience based on user votes. */
    async function updateAverageRating() {
      const reviews = await getRoomReviews();
      const rating = calculateAverageRating(reviews);
      const ratingEl = document.getElementById('averageRating');

      if (rating.total === 0) {
        ratingEl.innerHTML = '<span class="text-muted">No reviews yet</span>';
      } else {
        const color = rating.percentage >= 50 ? 'text-success' : 'text-danger';
        ratingEl.innerHTML =
          `<span class="${color}">${rating.percentage}% ${rating.sentiment}</span>
           <span class="text-muted fs-6">(${rating.total})</span>`;
      }
    }

    /* Escapes potentially unsafe text before injecting it into the DOM
       to prevent any form of cross-site scripting. */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    /* Renders all reviews and replies to the page.
       Builds each card dynamically, including:
         - author info
         - category + timestamp
         - thumbs count
         - edit/delete buttons (only for author)
         - reply list + reply form
       Re-runs automatically after any database update to stay in sync. */
    function renderReviews() {
      getRoomReviews().then(reviews => {
        const reviewsList = document.getElementById('reviewsList');
        reviewsList.innerHTML = '';

        if (reviews.length === 0) {
          reviewsList.innerHTML = '<div class="text-muted text-center p-4">No reviews yet for this room.</div>';
          return;
        }

        reviews.forEach((review, index) => {
          const card = document.createElement('div');
          card.className = 'card shadow-sm mb-3';

          card.innerHTML = `
            <div class="card-body">

              <!-- Review header: name, category, date, and edit/delete options -->
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="fw-semibold mb-1">${escapeHtml(review.name)}</h6>
                  <span class="badge bg-secondary">${escapeHtml(review.category)}</span>
                  <small class="text-muted ms-2">${new Date(review.timestamp).toLocaleDateString()}</small>
                </div>

                ${review.userId === currentUserId ? `
                  <button class="btn btn-sm btn-outline-warning edit-btn" data-index="${index}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger delete-btn" data-index="${index}">
                    <i class="bi bi-trash"></i>
                  </button>
                ` : ''}
              </div>

              <!-- Review text body -->
              <p class="mb-3">${escapeHtml(review.text)}</p>

              <!-- Voting controls (disabled for review author) -->
              <div class="d-flex align-items-center gap-3 mb-3">
                <button class="btn btn-sm ${review.userVote === 'up' ? 'btn-success' : 'btn-outline-success'} thumb-btn"
                        data-index="${index}" data-type="up"
                        ${review.userId === currentUserId ? 'disabled' : ''}>
                  <i class="bi bi-hand-thumbs-up"></i> ${review.thumbsUp}
                </button>

                <button class="btn btn-sm ${review.userVote === 'down' ? 'btn-danger' : 'btn-outline-danger'} thumb-btn"
                        data-index="${index}" data-type="down"
                        ${review.userId === currentUserId ? 'disabled' : ''}>
                  <i class="bi bi-hand-thumbs-down"></i> ${review.thumbsDown}
                </button>
              </div>

              <!-- Replies list + input for adding new replies -->
              <div class="replies-section">
                ${(review.replies || []).map((reply, replyIndex) => `
                  <div class="ms-4 border-start ps-3 mb-2 p-2 bg-light rounded">
                    <div class="d-flex justify-content-between">
                      <strong class="small">${escapeHtml(reply.name)}</strong>
                      ${reply.userId === currentUserId ? `
                        <button class="btn btn-sm btn-link text-danger p-0 delete-reply-btn"
                                data-index="${index}" data-reply-index="${replyIndex}">
                          <i class="bi bi-trash"></i>
                        </button>` : ''}
                    </div>
                    <p class="small mb-0 mt-1">${escapeHtml(reply.text)}</p>
                  </div>
                `).join('')}

                <!-- Reply form for each review -->
                <form class="reply-form mt-2" data-index="${index}">
                  <div class="input-group input-group-sm">
                    <input type="text" class="form-control reply-name" placeholder="Your name" required>
                    <input type="text" class="form-control reply-text" placeholder="Write a reply..." required>
                    <button type="submit" class="btn btn-outline-primary">Reply</button>
                  </div>
                </form>
              </div>

            </div>
          `;

          reviewsList.appendChild(card);
        });

        attachEventListeners();
      });
    }

    /* Because review cards are dynamically recreated, event listeners must be
       re-attached after every render cycle. This function binds delete, reply,
       and other interactive controls. */
    function attachEventListeners() {

      /* Delete review button */
      document.querySelectorAll('.delete-btn').forEach(btn =>
        btn.addEventListener('click', async e => {
          if (confirm('Delete this review?')) {
            const index = e.currentTarget.dataset.index;
            const reviews = await getRoomReviews();
            await deleteRoomReview(reviews[index].id);
            renderReviews();
          }
        })
      );

      /* Delete reply button */
      document.querySelectorAll('.delete-reply-btn').forEach(btn =>
        btn.addEventListener('click', async e => {
          const index = e.currentTarget.dataset.index;
          const replyIndex = e.currentTarget.dataset.replyIndex;

          const reviews = await getRoomReviews();
          const review = reviews[index];
          review.replies.splice(replyIndex, 1);

          await editRoomReview(review.id, review);
          renderReviews();
        })
      );

      /* Reply submissions for each review */
      document.querySelectorAll('.reply-form').forEach(form =>
        form.addEventListener('submit', async e => {
          e.preventDefault();
          const index = form.dataset.index;
          const name = form.querySelector('.reply-name').value.trim();
          const text = form.querySelector('.reply-text').value.trim();
          if (!name || !text) return;

          const reviews = await getRoomReviews();
          const review = reviews[index];

          const reply = {
            userId: currentUserId,
            name,
            text,
            timestamp: Date.now()
          };

          review.replies = review.replies || [];
          review.replies.push(reply);
          await editRoomReview(review.id, review);

          renderReviews();
        })
      );
    }

    /* Handles submission of new reviews.
       Validates form input, builds the review object, assigns vote values,
       and saves everything to Firestore. Also resets the UI afterward. */
    document.getElementById('reviewForm').addEventListener('submit', async e => {
      e.preventDefault();

      const review = {
        userId: currentUserId,
        category: reviewCategory.value,
        name: reviewerName.value.trim(),
        text: reviewText.value.trim(),
        thumbsUp: reviewThumb.value === 'up' ? 1 : 0,
        thumbsDown: reviewThumb.value === 'down' ? 1 : 0,
        userVote: reviewThumb.value,
        votes: { [currentUserId]: reviewThumb.value },
        replies: []
      };

      await saveRoomReview(review);

      /* Reset form UI */
      reviewCategory.value = '';
      reviewerName.value = '';
      reviewText.value = '';
      reviewThumb.value = '';
      thumbUpBtn.classList.remove('btn-success');
      thumbUpBtn.classList.add('btn-outline-success');
      thumbDownBtn.classList.remove('btn-danger');
      thumbDownBtn.classList.add('btn-outline-danger');

      renderReviews();
      updateAverageRating();
    });

    /* Load existing reviews and initialize UI on page startup. */
    updateAverageRating();
    renderReviews();
  </script>

</body>
</html>
